buildscript {
    dependencies {
        classpath 'org.yaml:snakeyaml:2.4'
    }
}

plugins {
    // id 'org.mybatis.generator'
    id 'org.flywaydb.flyway'
}

dependencies {
    // // MyBatis Generator dependencies
    // mybatisGenerator 'org.mybatis.generator:mybatis-generator-core:1.4.2'
    // mybatisGenerator 'mysql:mysql-connector-java:8.0.33'
    
    // PostgreSQL driver for Flyway
    implementation 'org.postgresql:postgresql:42.6.0'
    // // YAML parsing library
    // implementation 'org.yaml:snakeyaml:2.0'
}

// // MyBatis Generator configuration
// mybatisGenerator {
//     verbose = true
//     overwrite = true
//     configFile = 'src/main/resources/generatorConfig.xml'
// }

// Function to parse YAML properties using SnakeYAML library
def getDatasourceFromYaml(String filePath) {
    def yaml = new org.yaml.snakeyaml.Yaml()
    // def inputStream = new FileInputStream(file(filePath))
    def yamlData = yaml.load(file(filePath))
    // inputStream.close()
    // Extract datasource properties with proper hierarchy handling
    def datasourceConfig = yamlData.datasource
    def datasource = [:]
    datasource.url = datasourceConfig.url
    datasource.username = datasourceConfig.username
    datasource.password = datasourceConfig.password
    datasource.driverClassName = datasourceConfig['driver-class-name']
    return datasource
}

// // Default Flyway configuration (kept for backward compatibility)
// flyway {
//     url = 'jdbc:mysql://localhost:3306/employee_management'
//     user = 'root'
//     password = 'password'
//     locations = ['classpath:db/migration']
//      baselineOnMigrate = true
// }

// Flyway task for employee_management database (includes local data)
task migrateDb(type: org.flywaydb.gradle.task.FlywayMigrateTask) {
    group = 'flyway'
    description = 'Migrates the employee_management database including local test data'
    
    doFirst {
        def datasource = getDatasourceFromYaml('src/main/resources/my-properties.yml')
        
        url = datasource.url
        user = datasource.username
        password = datasource.password
        locations = ['classpath:db/migration', 'classpath:db/migration/local']
        baselineOnMigrate = true
    }
}

// Flyway task for employee_management_ut database (DDL only)
task migrateUtDb(type: org.flywaydb.gradle.task.FlywayMigrateTask) {
    group = 'flyway'
    description = 'Migrates the employee_management_ut database with DDL only (no test data)'
    
    doFirst {
        def datasource = getDatasourceFromYaml('src/main/resources/my-properties-ut.yml')
        
        url = datasource.url
        user = datasource.username
        password = datasource.password
        locations = ['classpath:db/migration']
        baselineOnMigrate = true
    }
}
